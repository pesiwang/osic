<?php
require_once __DIR__ . '/<!--{$set->getName()|name2file}-->.router.php';
class SetElement_<!--{$set->getName()|name2class}-->{
<!--{foreach from=$set->getFields() key=name item=field}-->
	public $_<!--{$name}--> = <!--{if $field->getType() == SetField::TYPE_STRING}-->'<!--{$field->getValue()}-->'<!--{else}--><!--{$field->getValue()}--><!--{/if}-->;
<!--{/foreach}-->
<!--{foreach from=$set->getFields()|array_keys item=field}-->

	public function get<!--{$field|ucfirst}-->(){
		return $this->_<!--{$field}-->;
	}
	
	public function set<!--{$field|ucfirst}-->($<!--{$field}-->){
		$this->_<!--{$field}--> = $<!--{$field}-->;
		return $this;
	}
<!--{/foreach}-->
}

class Set_<!--{$set->getName()|name2class}-->{
    const CAPACITY = <!--{$set->getCapacity()}-->;

	static public function fetch($id, $elementId){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !isset($elements[$elementId]))
			return NULL;
		
		return $elements[$elementId];
	}
	
	static public function put($id, $elementId, SetElement_<!--{$set->getName()|name2class}--> $element){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			$elements = array();
		
		$elements[$elementId] = $element;
		if(count($elements) > <!--{$set->getCapacity()}-->)
			throw new SetException('max capacity "<!--{$set->getCapacity()}-->)" reached');

		SetRouterCurrent_<!--{$set->getName()|name2class}-->::save($id, $elements);
	}
	
	static public function puts($id, Array $elements){
		$oldElements = self::_loadElements($id);
		if(!isset($oldElements) || !is_array($oldElements))
			$oldElements = array();
		
		$elements += $oldElements;
		if(count($elements) > <!--{$set->getCapacity()}-->)
			throw new SetException('max capacity "<!--{$set->getCapacity()}-->)" reached');

		SetRouterCurrent_<!--{$set->getName()|name2class}-->::save($id, $elements);
	}
	
	static public function erase($id, $elementId){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements) || !isset($elements[$elementId]))
			return;
		
		unset($elements[$elementId]);
		SetRouterCurrent_<!--{$set->getName()|name2class}-->::save($id, $elements);
	}
	
	static public function clear($id){
		SetRouterCurrent_<!--{$set->getName()|name2class}-->::save($id, array());
	}
	
	static public function count($id){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			return 0;
		return count($elements);
	}
	
<!--{foreach from=$set->getFields() key=name item=field}-->
<!--{if $field->getIndex() != SetField::INDEX_NONE}-->
	static public function listBy<!--{$name|ucfirst}-->($id, $offset, $number){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			return array();
<!--{if $field->getIndex() != SetField::INDEX_STRING}-->
		uasort($elements, create_function('$lhs, $rhs', 'return strcmp($lhs->get<!--{$name|ucfirst}-->(), $rhs->get<!--{$name|ucfirst}-->());'));
<!--{else}-->	
		uasort($elements, create_function('$lhs, $rhs', 'return $lhs->get<!--{$name|ucfirst}-->() - $rhs->get<!--{$name|ucfirst}-->();'));
<!--{/if}-->
		return array_slice($elements, $offset, $number, true);
	}
<!--{/if}-->
<!--{/foreach}-->
	
	/////////////////////////////////////////
	
	static private function _loadElements($id){
		$elements = SetRouterCurrent_<!--{$set->getName()|name2class}-->::load($id);
<!--{if isset($obsolete_router)}-->
		if(!isset($elements)){
			$elements = SetRouterObsolete_<!--{$set->getName()|name2class}-->::load($id);
			if(isset($elements))
				SetRouterCurrent_<!--{$set->getName()|name2class}-->::save($id, $elements);
		}
<!--{/if}-->
		return $elements;
	}
}
