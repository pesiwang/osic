<?php
class SetStorage<!--{if isset($current_router)}-->Current<!--{else}-->Obsolete<!--{/if}-->_<!--{$set->getName()|name2class}-->{
	private $_connParam = null;
	
	public function __construct(Array $connParam){
		if(!is_array($connParam) || !isset($connParam['host']) || !isset($connParam['port']) || !isset($connParam['user']) || !isset($connParam['pass']) || !isset($connParam['database']) || !isset($connParam['table']))
			throw new SetException('incorrect mysql parameter');
		$this->_connParam = $connParam;
	}
	
	public function load($id){
		$elements = null;
		try{
			$pdo = self::_connectToMedia($this->_connParam);
			$stmt = $pdo->prepare('SELECT data FROM ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' WHERE id=:id');
			$stmt->bindValue(':id', $id);
			$stmt->execute();
			if($row = $stmt->fetch(PDO::FETCH_ASSOC)){
				$datas = igbinary_unserialize($row['data']);
				if(is_array($datas)){
					$elements = array();
					foreach($datas as $elementId => $attrs){
						$element = new SetElement_<!--{$set->getName()|name2class}-->();
<!--{foreach from=$set->getFields()|array_keys item=field}-->
						if(isset($attrs['<!--{$field}-->']))
							$element->set<!--{$field|ucfirst}-->($attrs['<!--{$field}-->']);
<!--{/foreach}-->
						$elements[$elementId] = $element;
					}
				}
			}
		}
		catch(Exception $e){
			throw new SetException('failed on GET command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port']. ' underlying msg:' . $e->getMessage());
		}
		return $elements;
	}
	
	public function save($id, Array $elements){
		$datas = array();
		foreach($elements as $elementId => $element){
			$attrs = array();
<!--{foreach from=$set->getFields()|array_keys item=field}-->
			$attrs['<!--{$field}-->'] = $element->get<!--{$field|ucfirst}-->();
<!--{/foreach}-->
			$datas[$elementId] = $attrs;
		}
		try{
			$pdo = self::_connectToMedia($this->_connParam);	
			$stmt = $pdo->prepare('REPLACE INTO ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' set id=:id, data=:data');
			$stmt->bindValue(':id', $id);
			$stmt->bindValue(':data', igbinary_serialize($datas));
			$stmt->execute();
		}
		catch(Exception $e){
			throw new SetException('failed on SET command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port'] . ' underlying msg:' . $e->getMessage());
		}
	}
	
	//------------private functions-------------//

	static private function _connectToMedia($connParam){
		$dsn = 'mysql:host=' . $connParam['host'] . ';port=' . $connParam['port'];
		$pdo = new PDO($dsn, $connParam['user'], $connParam['pass'], array(PDO::ATTR_PERSISTENT => true, PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES \'UTF8\''));
		$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

		return $pdo;
	}
}