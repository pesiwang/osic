<?php
require_once __DIR__ . '/<!--{$queue->getName()|name2file}-->.router.php';
class QueueElement_<!--{$queue->getName()|name2class}-->{
	public $_id;
<!--{foreach from=$queue->getFields() key=name item=field}-->
	public $_<!--{$name}--> = <!--{if $field->getType() == QueueField::TYPE_STRING}-->'<!--{$field->getValue()}-->'<!--{else}--><!--{$field->getValue()}--><!--{/if}-->;
<!--{/foreach}-->

	public function getId(){
		return $this->_id;
	}

	public function setId($id){
		$this->_id = $id;
		return $this;
	}
<!--{foreach from=$queue->getFields()|array_keys item=field}-->

	public function get<!--{$field|ucfirst}-->(){
		return $this->_<!--{$field}-->;
	}
	
	public function set<!--{$field|ucfirst}-->($<!--{$field}-->){
		$this->_<!--{$field}--> = $<!--{$field}-->;
		return $this;
	}
<!--{/foreach}-->
}

class Queue_<!--{$queue->getName()|name2class}-->{
	const CAPACITY = <!--{$queue->getCapacity()}-->;

	static public function push($id, QueueElement_<!--{$queue->getName()|name2class}--> $element){
		self::erase($id, $element->getId());

		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			$elements = array();
		
		array_unshift($elements, $element);
		if(count($elements) > <!--{$queue->getCapacity()}-->)
			$elements = array_slice($elements, 0, <!--{$queue->getCapacity()}-->);

		QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::save($id, $elements);
	}

	static public function pop($id){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements) || (count($elements) <= 0))
			return null;
		
		$popedElements = array_splice($elements, count($elements) - 1, 1);
		QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::save($id, $elements);
		return $popedElements[0];
	}

	static public function has($id, $elementId){
		$elements = self::_loadElements($id);
        if(!isset($elements))
            return false;

		foreach($elements as $idx => $element)
			if($element->getId() == $elementId)
				return true;
		return false;
	}
	
	static public function erase($id, $elementId){
		$elements = self::_loadElements($id);
        if(!isset($elements))
            return;

		foreach($elements as $idx => $element){
			if($element->getId() == $elementId)
				unset($elements[$idx]);
		}
		QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::save($id, $elements);
	}
	
	static public function clear($id){
		QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::save($id, array());
	}
	
	static public function count($id){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			return 0;
		return count($elements);
	}
	
	static public function peek($id, $offset, $number){
		$elements = self::_loadElements($id);
		if(!isset($elements) || !is_array($elements))
			return array();
		return array_slice($elements, $offset, $number, true);
	}
	
	/////////////////////////////////////////
	
	static private function _loadElements($id){
		$elements = QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::load($id);
<!--{if isset($obsolete_router)}-->
		if(!isset($elements)){
			$elements = QueueRouterObsolete_<!--{$queue->getName()|name2class}-->::load($id);
			if(isset($elements))
				QueueRouterCurrent_<!--{$queue->getName()|name2class}-->::save($id, $elements);
		}
<!--{/if}-->
		return $elements;
	}
}
