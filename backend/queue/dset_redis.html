<?php
class QueueDset<!--{if isset($current_router)}-->Current<!--{else}-->Obsolete<!--{/if}-->_<!--{$queue->getName()|name2class}-->{
	private $_connParam = null;
	
	public function __construct(Array $connParam){
		if(!is_array($connParam) || !isset($connParam['host']) || !isset($connParam['port']) || !isset($connParam['name']))
			throw new QueueException('incorrect redis parameter');
		$this->_connParam = $connParam;
	}
	
	public function save($id, Array $elements){
		$redis = self::_connectToMedia($this->_connParam);
		try{
			$redis->hQueue($this->_connParam['name'], $id, 's');
		}
		catch(Exception $e){
			throw new QueueException('failed on HSET command to Redis server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port'] . ' underlying msg:' . $e->getMessage());
		}
	}
	
	//----------following function is designed for the dset consumer process---------//
	public function consume(){
		$dataArr = array();
		$redis = self::_connectToMedia($this->_connParam);
		try{
			$dataArr = $redis->multi()->hGetAll($this->_connParam['name'])->delete($this->_connParam['name'])->exec();
			if(!is_array($dataArr))
				return array();
			$dataArr = $dataArr[0];
		}
		catch(Exception $e){
			throw new QueueException('failed on HGETALL & DELETE command to Redis server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port'] . ' underlying msg:' . $e->getMessage());
		}
		return $dataArr;
	}
	
	//------------private functions-------------//
	
	static private function _connectToMedia($connParam){
		$redis = new Redis;
		$succ = $redis->pconnect($connParam['host'], $connParam['port']);
		if(!$succ)
			throw new QueueException('failed to connect to Redis server, host=' . $connParam['host'] . ' port=' . $connParam['port']);
		return $redis;
	}
}
