<?php
require_once __DIR__ . '/<!--{$index->getName()|name2file}-->.storage.php';

class IndexRouter_<!--{$index->getName()|name2class}-->{
	static private $_storages = array();
	static private $_storageConnParams = <!--{$router->getStorage()->getConnParams()|fill_params|dump_array}-->;

	static public function fetch($id, $elementId){
		return self::_getStorage($id)->fetch($id, $elementId);
	}

	static public function put($id, $elementId, $score){
		self::_getStorage($id)->put($id, $elementId, $score);
	}
	
	static public function puts($id, Array $elements){
		self::_getStorage($id)->puts($id, $elements);
	}

	static public function remove($id, $elementId){
		self::_getStorage($id)->remove($id, $elementId);
	}

	static public function clear($id){
		self::_getStorage($id)->clear($id);
	}

	static public function count($id){
		return self::_getStorage($id)->count($id);
	}

	static public function listAscending($id, $offset, $number){
		return self::_getStorage($id)->listAscending($id, $offset, $number);
	}
    
	static public function listDescending($id, $offset, $number){
		return self::_getStorage($id)->listDescending($id, $offset, $number);
	}
	
	//------------functions for private use------------//

	static public function _getStorage($id){
		$hashIdx = self::_getStorageHash($id);
		if(isset(self::$_storages[$hashIdx]))
			return self::$_storages[$hashIdx];

		self::$_storages[$hashIdx] = new IndexStorage_<!--{$index->getName()|name2class}-->(self::getStorageConnParam($hashIdx));
		return self::$_storages[$hashIdx];
	}
	
	static public function getStorageConnParam($hashIdx){
		if(!isset(self::$_storageConnParams[$hashIdx]))
			throw new IndexException('no route to storage at hash=' . $hashIdx);
		return self::$_storageConnParams[$hashIdx];
	}
	
	static public function _getStorageHash($id){
		<!--{$router->getStoragePolicy()|trim}-->
	}
}
