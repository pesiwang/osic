<?php
class ObjectStorage<!--{if isset($current_router)}-->Current<!--{else}-->Obsolete<!--{/if}-->_<!--{$object->getName()|name2class}-->{
	private $_connParam = null;
	
	public function __construct(Array $connParam){
		if(!is_array($connParam) || !isset($connParam['host']) || !isset($connParam['port']) || !isset($connParam['user']) || !isset($connParam['pass']) || !isset($connParam['database']) || !isset($connParam['table']))
			throw new ObjectException('incorrect mysql parameter');
		$this->_connParam = $connParam;
	}
	
	public function get($id){
		$object = null;
		try{
			$pdo = self::_connectToMedia($this->_connParam);
			$stmt = $pdo->prepare('SELECT data FROM ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' WHERE id=:id');
			$stmt->bindValue(':id', $id);
			$stmt->execute();
			if($row = $stmt->fetch(PDO::FETCH_ASSOC)){
				$data = igbinary_unserialize($row['data']);
				if(is_array($data)){
					$object = new Object_<!--{$object->getName()|name2class}-->();
<!--{foreach from=$object->getFields()|array_keys item=field}-->
					if(isset($data['<!--{$field}-->']))
						$object->set<!--{$field|ucfirst}-->($data['<!--{$field}-->']);
<!--{/foreach}-->
				}
			}
		}
		catch(Exception $e){
			throw new ObjectException('failed on GET command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port']. ' underlying msg:' . $e->getMessage());
		}
		return $object;
	}
	
	public function gets(Array $ids){
		$objects = array();
		try{
			$pdo = self::_connectToMedia($this->_connParam);
			$sql = 'SELECT id, data FROM ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' WHERE';
			for($idx = 0; $idx < count($ids); ++$idx){
				if($idx > 0) $sql .= ' OR';
				$sql .= ' id=:id' . $idx;
			}
			$stmt = $pdo->prepare($sql);
			for($idx = 0; $idx < count($ids); ++$idx)
				$stmt->bindValue(':id' . $idx, $ids[$idx]);
			$stmt->execute();
			while($row = $stmt->fetch(PDO::FETCH_ASSOC)){
				$id = $row['id'];
				$data = igbinary_unserialize($row['data']);
				if(is_array($data)){
					$object = new Object_<!--{$object->getName()|name2class}-->();
<!--{foreach from=$object->getFields()|array_keys item=field}-->
					if(isset($data['<!--{$field}-->']))
						$object->set<!--{$field|ucfirst}-->($data['<!--{$field}-->']);
<!--{/foreach}-->
					$objects[$id] = $object;
				}
			}
		}
		catch(Exception $e){
			throw new ObjectException('failed on GETS command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port']. ' underlying msg:' . $e->getMessage());
		}
		return $objects;
	}
	
	public function set($id, Object_<!--{$object->getName()|name2class}--> $object){
		$data = array();
<!--{foreach from=$object->getFields()|array_keys item=field}-->
		$data['<!--{$field}-->'] = $object->get<!--{$field|ucfirst}-->();
<!--{/foreach}-->
		try{
			$pdo = self::_connectToMedia($this->_connParam);	
			$stmt = $pdo->prepare('REPLACE INTO ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' set id=:id, data=:data');
			$stmt->bindValue(':id', $id);
			$stmt->bindValue(':data', igbinary_serialize($data));
			$stmt->execute();
		}
		catch(Exception $e){
			throw new ObjectException('failed on SET command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port'] . ' underlying msg:' . $e->getMessage());
		}
	}
	
	public function del($id){
		try{
			$pdo = self::_connectToMedia($this->_connParam);
			$stmt = $pdo->prepare('DELETE FROM ' . $this->_connParam['database'] . '.' . $this->_connParam['table'] . ' WHERE id=:id');
			$stmt->bindValue(':id', $id);
			$stmt->execute();
		}
		catch(Exception $e){
			throw new ObjectException('failed on DEL command to Mysql server, host = ' . $this->_connParam['host'] . ' port = ' . $this->_connParam['port'] . ' underlying msg:' . $e->getMessage());
		}
	}
	
	//------------private functions-------------//

	static private function _connectToMedia($connParam){
		$dsn = 'mysql:host=' . $connParam['host'] . ';port=' . $connParam['port'];
		$pdo = new PDO($dsn, $connParam['user'], $connParam['pass'], array(PDO::ATTR_PERSISTENT => true, PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES \'UTF8\''));
		$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

		return $pdo;
	}
}
